{% extends "downtime_tracker/base.html" %}
{% block title %}{{ equipment.asset_number }} — Downtime Tracker{% endblock %}

{% block content %}

<style>
  .truncate {
    max-width: 520px;     /* tweak */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
  }
  .truncate-sm {
    max-width: 360px;     /* tweak */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
  }
</style>

  <div class="card">
    <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;">
      <div>
        <h2 style="margin-top:0;">{{ equipment.asset_number }}</h2>
        <div><strong>{{ equipment.description }}</strong></div>

        <div class="muted">
          Department:
          <a href="{% url 'downtime_tracker:department_detail' equipment.department.code %}?year={{ year }}&cat={{ cat }}">
            {{ equipment.department.name }}
          </a>
        </div>

        {% if equipment.location %}
          <div class="muted">Location: {{ equipment.location }}</div>
        {% endif %}
      </div>

      <div style="text-align:right;">
        <div class="muted">Current Status</div>

        {% if equipment.status == "UP" %}
          <span class="status-pill up">UP</span>
        {% else %}
          <span class="status-pill down">DOWN</span>
        {% endif %}

        <div style="height:10px;"></div>

        {% if perms.downtime_tracker.change_equipment %}
          <a class="btn btn-primary"
             href="{% url 'downtime_tracker:change_status' equipment.id %}?next={{ request.get_full_path|urlencode }}">
             Change Status
          </a>

          <a class="btn"
             href="{% url 'downtime_tracker:equipment_export_csv' equipment.id %}?year={{ year }}&cat={{ cat }}">
             Export CSV
          </a>
        {% endif %}
      </div>
    </div>

    {% if equipment.status == "DOWN" and open_event %}
      <div style="height:12px;"></div>
      <div class="card" style="background:#fff7ed; border:1px solid #fed7aa;">
        <div>
          <strong>Down reason:</strong>
          <span class="truncate" title="{{ open_event.start_comment }}">
            {{ open_event.start_comment|truncatechars:160 }}
          </span>
        </div>
        <div><strong>Category:</strong> {{ open_event.get_category_display }}</div>
        <div class="muted">Down since: {{ open_event.started_at }}</div>
      </div>
    {% endif %}
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
      <h3 style="margin:0;">
        Downtime Summary
        {% if cat != "ALL" %}
          — {{ cat }}
        {% endif %}
      </h3>

      <form method="get" style="display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap;">
        <div>
          <label for="year">Year</label><br>
          <select name="year" id="year">
            {% for y in years %}
              <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label for="cat">Downtime Type</label><br>
          <select name="cat" id="cat">
            <option value="ALL" {% if cat == "ALL" %}selected{% endif %}>All</option>
            {% for v,l in cat_choices %}
              <option value="{{ v }}" {% if cat == v %}selected{% endif %}>{{ l }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <button class="btn" type="submit">Apply</button>
        </div>
      </form>
    </div>

    <div style="height:10px;"></div>
    <div><strong>Total downtime ({{ year }}):</strong> {{ total_days_year }} days</div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <h3 style="margin-top:0;">
      Downtime Events
      {% if cat != "ALL" %}
        — {{ cat }}
      {% endif %}
    </h3>

    <table class="table">
      <thead>
        <tr>
          <th>Start</th>
          <th>End</th>
          <th>Duration (days)</th>
          <th>Type</th>
          <th>Start comment</th>
          <th>End comment</th>
        </tr>
      </thead>
      <tbody>
        {% for ev in events_all %}
          <tr>
            <td>{{ ev.started_at }}</td>
            <td>
              {% if ev.ended_at %}
                {{ ev.ended_at }}
              {% else %}
                <span class="status-pill down">OPEN</span>
              {% endif %}
            </td>
            <td>{{ ev.duration_days|floatformat:3 }}</td>
            <td>{{ ev.get_category_display }}</td>

            <td>
              {% if ev.start_comment %}
                <span class="truncate-sm" title="{{ ev.start_comment }}">
                  {{ ev.start_comment|truncatechars:90 }}
                </span>
              {% else %}
                —
              {% endif %}
            </td>

            <td>
              {% if ev.end_comment %}
                <span class="truncate-sm" title="{{ ev.end_comment }}">
                  {{ ev.end_comment|truncatechars:90 }}
                </span>
              {% else %}
                —
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="6" class="muted">No downtime events recorded for this equipment.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if cat == "ALL" %}
      <div style="height:14px;"></div>

      <h3 style="margin-top:0;">Downtime Breakdown ({{ year }})</h3>
      <div style="max-width:720px;">
        <canvas id="downtimeBreakdown" height="110"></canvas>
      </div>

      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script>
        const breakdownLabels = {{ chart_labels_json|safe }};
        const breakdownValues = {{ chart_values_json|safe }};

        const ctx2 = document.getElementById('downtimeBreakdown');
        new Chart(ctx2, {
          type: 'bar',
          data: {
            labels: breakdownLabels,
            datasets: [{
              label: 'Downtime (days)',
              data: breakdownValues
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: true } },
            scales: { y: { beginAtZero: true } }
          }
        });
      </script>
    {% endif %}
  </div>

{% endblock %}
