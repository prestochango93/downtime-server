{% extends "downtime_tracker/base.html" %}
{% block title %}Plant Dashboard — Downtime Tracker{% endblock %}

{% block content %}

<!-- ================= HEADER / FILTERS ================= -->
<div class="card">
  <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;">
    <div>
      <h2 style="margin-top:0;">Plant Dashboard</h2>
      <div class="muted">
        Year: <strong>{{ year }}</strong>
        {% if cat != "ALL" %}
          · Type: <strong>{{ cat }}</strong>
        {% else %}
          · Type: <strong>ALL</strong>
        {% endif %}
      </div>
    </div>

    <form method="get" style="display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap;">
      <div style="min-width:120px;">
        <label for="id_year">Year</label>
        <input id="id_year" name="year" type="number" value="{{ year }}" style="width:120px;">
      </div>

      <div style="min-width:220px;">
        <label for="id_cat">Downtime Type</label>
        <select id="id_cat" name="cat">
          <option value="ALL" {% if cat == "ALL" %}selected{% endif %}>All</option>
          {% for v,l in cat_choices %}
            <option value="{{ v }}" {% if cat == v %}selected{% endif %}>{{ l }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <button class="btn btn-primary" type="submit">Apply</button>
      </div>
    </form>
  </div>
</div>

<div style="height:18px;"></div>

<!-- ================= CURRENTLY DOWN ================= -->
<div class="card">
  <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;">
    <div>
      <h2 style="margin:0;">Currently Down</h2>
      <div class="muted" style="margin-top:4px;">
        Open downtime events right now
        {% if cat != "ALL" %}
          · Filtered to: <strong>{{ cat }}</strong>
        {% endif %}
      </div>
    </div>
    <div class="muted" style="font-weight:700;">
      Total down: {{ down_total_count }}
    </div>
  </div>

  <div style="height:12px;"></div>

  {% if down_total_count == 0 %}
    <div class="muted">No equipment is currently down.</div>
  {% else %}

    {% for dept in down_by_department %}
      <div style="margin-top:14px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <h3 style="margin:0;">
            {{ dept.department_name }}
          </h3>
          <a class="btn"
             href="{% url 'downtime_tracker:department_detail' dept.department_code %}?year={{ year }}&cat={{ cat }}">
             View department
          </a>
        </div>

        <div style="height:8px;"></div>

        <table class="table">
          <thead>
            <tr>
              <th style="width:140px;">Asset</th>
              <th>Description</th>
              <th style="width:260px;">Reason</th>
              <th style="width:170px;">Type</th>
              <th style="width:200px;">Down Since</th>
              <th style="width:120px;">Down For</th>
            </tr>
          </thead>
          <tbody>
            {% for row in dept.items %}
              <tr>
                <td><strong>{{ row.asset_number }}</strong></td>
                <td>{{ row.description }}</td>

                <!-- Truncated reason w/ hover tooltip + click-to-expand -->
                <td>
                  <span
                    class="reason-trunc"
                    title="{{ row.reason|default_if_none:'' }}">
                    {{ row.reason|default_if_none:'' }}
                  </span>
                </td>

                <td>{{ row.category_label }}</td>
                <td>{{ row.down_since|date:"Y-m-d H:i" }}</td>
                <td><span class="status-pill down">{{ row.down_for }}</span></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}

  {% endif %}
</div>

<div style="height:18px;"></div>

<!-- ================= KPIs ================= -->
<div class="grid">
  <div class="card">
    <div class="muted">Total Downtime</div>
    <h2 style="margin:4px 0;">{{ kpi_total_days }} days</h2>
  </div>

  <div class="card">
    <div class="muted">Events</div>
    <h2 style="margin:4px 0;">{{ kpi_event_count }}</h2>
  </div>

  <div class="card">
    <div class="muted">MTTR</div>
    <h2 style="margin:4px 0;">{{ kpi_mttr }} hrs</h2>
  </div>

  <div class="card">
    <div class="muted">MTBF</div>
    <h2 style="margin:4px 0;">{{ kpi_mtbf }} hrs</h2>
  </div>
</div>

<div style="height:18px;"></div>

<!-- ================= CHARTS ================= -->
<div class="grid">

  <div class="card">
    <h3 style="margin-top:0;">Downtime by Department (Pareto)</h3>
    <canvas id="paretoChart" height="160"></canvas>
    {% if pareto_labels_json == "[]" %}
      <div class="muted" style="margin-top:10px;">No downtime recorded for the selected filters.</div>
    {% endif %}
  </div>

  <div class="card">
    <h3 style="margin-top:0;">Planned vs Unplanned</h3>
    <canvas id="catChart" height="160"></canvas>
  </div>

</div>

<div style="height:22px;"></div>

<!-- ================= DEPARTMENTS ================= -->
<div class="card" id="departments">
  <h2 style="margin-top:0;">Departments</h2>
  <p class="muted">Select a department to view equipment status.</p>
</div>

<div style="height:14px;"></div>

<div class="grid">
  {% for d in departments %}
    <div class="card">
      <h3 style="margin:0 0 6px 0;">{{ d.name }}</h3>
      {% if d.description %}
        <div class="muted">{{ d.description }}</div>
      {% endif %}

      <div style="height:12px;"></div>

      <a class="btn btn-primary"
         href="{% url 'downtime_tracker:department_detail' d.code %}?year={{ year }}&cat={{ cat }}">
         View equipment
      </a>
    </div>
  {% empty %}
    <div class="card">No active departments yet.</div>
  {% endfor %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* Truncate the reason text to keep the table clean */
.reason-trunc{
  display:inline-block;
  max-width: 260px;         /* keep aligned with column width */
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  vertical-align: bottom;
  cursor: help;             /* hint that hover shows full text */
}

/* Optional: click-to-expand (toggles wrapping) */
.reason-trunc.expanded{
  max-width: none;
  white-space: normal;
  overflow: visible;
  cursor: pointer;
}
</style>

<script>
/* Click-to-expand reason cells */
document.addEventListener('click', (e) => {
  const el = e.target.closest('.reason-trunc');
  if (!el) return;
  el.classList.toggle('expanded');
});

/* Pareto */
const paretoLabels = {{ pareto_labels_json|safe }};
const paretoValues = {{ pareto_values_json|safe }};

if (paretoLabels && paretoLabels.length) {
  new Chart(document.getElementById('paretoChart'), {
    type: 'bar',
    data: { labels: paretoLabels, datasets: [{ label: 'Downtime (days)', data: paretoValues }] },
    options: { responsive: true, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
  });
}

/* Planned vs Unplanned */
const catLabels = {{ cat_labels_json|safe }};
const catValues = {{ cat_values_json|safe }};

new Chart(document.getElementById('catChart'), {
  type: 'pie',
  data: { labels: catLabels, datasets: [{ data: catValues }] },
  options: { responsive: true }
});
</script>

{% endblock %}
