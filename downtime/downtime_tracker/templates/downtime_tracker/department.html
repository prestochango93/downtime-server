{% extends "downtime_tracker/base.html" %}
{% load dt_extras %}
{% block title %}{{ department.name }} — Downtime Tracker{% endblock %}

{% block content %}

<style>
  .truncate-reason {
    max-width: 420px;   /* tweak if you want */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
  }
</style>

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
      <div>
        <h2 style="margin-top:0;">{{ department.name }}</h2>
        {% if department.description %}<div class="muted">{{ department.description }}</div>{% endif %}
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:end;">
        <form method="get" style="display:flex; gap:10px; flex-wrap:wrap; align-items:end;">
          <div>
            <label class="muted" for="id_year">Year</label><br>
            <input id="id_year" name="year" type="number" value="{{ year }}" style="width:110px;">
          </div>

          <div>
            <label class="muted" for="id_cat">Downtime Type</label><br>
            <select id="id_cat" name="cat">
              <option value="ALL" {% if cat == "ALL" %}selected{% endif %}>All</option>
              {% for v,l in cat_choices %}
                <option value="{{ v }}" {% if cat == v %}selected{% endif %}>{{ l }}</option>
              {% endfor %}
            </select>
          </div>

          <button class="btn" type="submit">Apply</button>
        </form>

        <a class="btn" href="{% url 'downtime_tracker:department_export_csv' department.code %}?year={{ year }}&cat={{ cat }}">Export CSV</a>
      </div>
    </div>
  </div>

  <div style="height:14px;"></div>

  <div class="card">
    <table class="table">
      <thead>
        <tr>
          <th>Asset #</th>
          <th>Description</th>
          <th>Status</th>
          <th>Down reason</th>
          <th class="right">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for e in equipment_list %}
          <tr>
            <td>
              <a href="{% url 'downtime_tracker:equipment_detail' e.id %}?year={{ year }}&cat={{ cat }}">{{ e.asset_number }}</a>
            </td>
            <td>{{ e.description }}</td>
            <td>
              {% if e.status == "UP" %}
                <span class="status-pill up">UP</span>
              {% else %}
                <span class="status-pill down">DOWN</span>
              {% endif %}
            </td>

            <td>
              {% if e.status == "DOWN" %}
                {% with ev=open_event_by_equipment_id|get_item:e.id %}
                  {% if ev %}
                    <span class="truncate-reason" title="{{ ev.start_comment }}">
                      {{ ev.start_comment|truncatechars:90 }}
                    </span>
                  {% else %}
                    <span class="muted">—</span>
                  {% endif %}
                {% endwith %}
              {% else %}
                <span class="muted">—</span>
              {% endif %}
            </td>

            <td class="right">
              {% if perms.downtime_tracker.change_equipment %}
                <a class="btn" href="{% url 'downtime_tracker:change_status' e.id %}">Change</a>
              {% else %}
                <span class="muted">View only</span>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="5" class="muted">No equipment found for this department.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div style="height:14px;"></div>

  <h3>Downtime (days)</h3>
  <div class="card">
    <canvas id="downtimeChart" height="110"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const labels = {{ chart_labels_json|safe }};
    const values = {{ chart_values_json|safe }};

    const ctx = document.getElementById('downtimeChart');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Downtime (days)',
          data: values
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: { y: { beginAtZero: true } }
      }
    });
  </script>

{% endblock %}
